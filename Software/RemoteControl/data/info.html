<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta name="theme-color" content="#404040"/>
		<title>TrackJet</title>
		<link rel="stylesheet" type="text/css" href="style.css">
		<style>
			body {
				overflow : hidden;
			}
			</style>
	</head>
    <body>
		<h1>TrackJet Info</h1>
		<p><a href='/'><input type = 'button' value = 'Remote Control page'/></a></p>
		<br>
		<div class="box" style="color: #FFE640;">
			<text id="batteryStatus">Battery: ---% </text><text id="batteryVoltage">---V</text>
		</div>


		<br>
		<br>
		<br>
		<div class="box">
        	<a href="https://github.com/vedatori/TrackJet" target="_blank">Official TrackJet Repository - GitHub</a>
        	<p>by <a href="http://wp.vedatori.com/">Vědátoři</a></p>
		</div>

		<div class="box">
        	<a href="https://github.com/vacjan321/TrackJet" target="_blank">TrackJet Fork - GitHub</a>
        	<p>fork by Vacjan</p>
		</div>
		<script>
			//_____________________________________________________________________________
			// This is called when the page finishes loading
			var clientURL;
			var clientConnected = false;
			function init() {
				// Connect to WebSocket server
				var str = window.location.hostname;
				clientURL = "ws://" + str + ":1337";
				wsConnect(clientURL);
				console.log(clientURL);
			}
			// Call this to connect to the WebSocket server
			function wsConnect(url) {
				if(clientConnected == true) {
					return;
				}
				
				// Connect to WebSocket server
				websocket = new WebSocket(url);
				
				// Assign callbacks
				websocket.onopen = function(evt) { onOpen(evt) };
				websocket.onclose = function(evt) { onClose(evt) };
				websocket.onmessage = function(evt) { onMessage(evt) };
				websocket.onerror = function(evt) { onError(evt) };
			}

			// Called when a WebSocket connection is established with the server
			function onOpen(evt) {

				// Log connection state
				console.log("Connected");

				clientConnected = true;
			}

			// Called when the WebSocket connection is closed
			function onClose(evt) {

				// Log disconnection state
				console.log("Disconnected");

				clientConnected = false;
				
				// Try to reconnect after a few seconds
				setTimeout(function() { wsConnect(clientURL) }, 1000);
			}

			// Called when a message is received from the server
			function onMessage(evt) {
				var receivedMessage = evt.data;
				var parsedMessage = receivedMessage.split(",");

				console.log("Received: " + receivedMessage);
				
				switch(parsedMessage[0]) {
					case "command":
						document.getElementById('commandInput').placeholder = parsedMessage[1];
						break;
					case "battery":
						document.getElementById('batteryStatus').innerText = "Battery: " + parsedMessage[1] + "% ";
						break;
					case "batteryVoltage":
						document.getElementById('batteryVoltage').innerText = parsedMessage[1] + "V";
						break;
					default:
						break;
				}
			}

			// Called when a WebSocket error occurs
			function onError(evt) {
				console.log("ERROR: " + evt.data);
			}

			// Sends a message to the server (and prints it to the console)
			function doSend(message) {
				if(websocket.readyState == WebSocket.OPEN) {
					console.log("Sending: " + message);
					websocket.send(message);
				}
			}
			
			/*
			function commandEnter(){
				var command = document.getElementById("commandInput");
				var commandText = command.value;
				if(commandText.length < 32) {
					doSend("command," + commandText);
				}
				command.value = "";
			}

			document.getElementById("commandInput").addEventListener("keyup", function(e) {
				if (e.keyCode == 13) {
					commandEnter();
				}
			});
			*/

			// Call the init function as soon as the page loads
			window.addEventListener("load", init, false);

			const view = document.getElementById('stream');
			const WS_URL = "ws://" + window.location.host + ":82";
			const ws = new WebSocket(WS_URL);
					
			ws.onmessage = message => {
				if (message.data instanceof Blob) {
				var urlObject = URL.createObjectURL(message.data);
				view.src = urlObject;
				}
			};
		</script>
    </body>
</html>